# 从输入url发生了什么

## 前言

这道题涉及范围广，而且可以很深，简单列步骤，再又浅入深入

1. DNS 解析， 如果有缓存用缓存
2. http链接， 三次握手，四次挥手
3. 链接 返回 页面
4. 解析html， ast， 生成 dom tree 和 css( Cascading Style Sheets) 样式层叠表, 浏览器对我们真的很包容
5. 画layout tree，开始渲染，将dom tree和css，一一对应
6. 建立图层树，生成绘制列表， 栅栏格化， 绘制， 排版，最后出来页面

### 正确姿势

先分成大框架，然后学习细节，层层递进，方便理解和记忆

1. 网络
2. 构建Dom树
3. 样式计算
4. 生成布局树(Layout Tree)
5. 建图层树
6. 绘制

#### 网络

1. 构建请求行
2. 查找强缓存
3. DNS解析
   1. 浏览器提供了DNS数据缓存功能。即如果一个域名已经解析过，那会把解析的结果缓存下来，下次处理直接走缓存，不需要经过 DNS解析
4. 建立TCP连接
   1. 3次握手 4次挥手
5. 发送http请求
   1. 请求行、请求头和请求体
6. 网络响应
   1. 响应行、响应头和响应体

响应完成之后怎么办？TCP 连接就断开了吗？
不一定。这时候要判断Connection字段, 如果请求头或响应头中包含Connection: Keep-Alive，表示建立了持久连接，这样TCP连接会一直保持，之后请求统一站点的资源会复用这个连接。
否则断开TCP连接, 请求-响应流程结束。

![alt](https://user-gold-cdn.xitu.io/2019/12/15/16f080b095268038?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

#### 解析算法篇

1. 构建 DOM 树
   1. HTML文法的本质， 上下文无关文法
   2. 解析算法
      1. 标记化。
      2. 建树。
         1. 将DOM对象加入 DOM 树中。
         2. 将对应标记压入存放开放(与闭合标签意思对应)元素的栈中。
      3. 容错机制
2. 样式计算
   1. 格式化样式表 styleSheets
   2. 标准化样式属性
   3. 计算每个节点的具体样式
3. 计算每个节点的具体样式
   1. 继承， 每个子节点都会默认继承父节点的样式属性，如果父节点中没有找到，就会采用浏览器默认样式，也叫UserAgent样式。这就是继承规则
   2. 层叠
4. 生成布局树
   1. 遍历生成的 DOM 树节点，并把他们添加到布局树中。
   2. 计算布局树节点的坐标位置。

![alt](https://user-gold-cdn.xitu.io/2019/12/15/16f080b2f718e4ad?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

#### 渲染

1. 建立图层树(Layer Tree)
   1. 显式合成
   2. 隐式合成
2. 生成绘制列表
   1. 接下来渲染引擎会将图层的绘制拆分成一个个绘制指令，比如先画背景、再描绘边框......然后将这些指令按顺序组合成一个待绘制列表，相当于给后面的绘制操作做了一波计划
   2. 大家可以在 Chrome 开发者工具中在设置栏中展开 more tools, 然后选择Layers面板，就能看到下面的绘制列表
3. 生成图块并栅格化
   1. 现在开始绘制操作，实际上在渲染进程中绘制操作是由专门的线程来完成的，这个线程叫合成线程。
4. 显示器显示内容
   1. 栅格化操作完成后，合成线程会生成一个绘制命令，即"DrawQuad"，并发送给浏览器进程。

浏览器进程中的viz组件接收到这个命令，根据这个命令，把页面内容绘制到内存，也就是生成了页面，然后把这部分内存发送给显卡。为什么发给显卡呢？我想有必要先聊一聊显示器显示图像的原理。
无论是 PC 显示器还是手机屏幕，都有一个固定的刷新频率，一般是 60 HZ，即 60 帧，也就是一秒更新 60 张图片，一张图片停留的时间约为 16.7 ms。而每次更新的图片都来自显卡的前缓冲区。而显卡接收到浏览器进程传来的页面后，会合成相应的图像，并将图像保存到后缓冲区，然后系统自动将前缓冲区和后缓冲区对换位置，如此循环更新。
看到这里你也就是明白，当某个动画大量占用内存的时候，浏览器生成图像的时候会变慢，图像传送给显卡就会不及时，而显示器还是以不变的频率刷新，因此会出现卡顿，也就是明显的掉帧现象。

![alt](https://user-gold-cdn.xitu.io/2019/12/15/16f080b7b8926b7f?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

## 总结

### 参考文献

1. <https://juejin.cn/post/6844904021308735502#heading-26>
