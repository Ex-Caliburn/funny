# hls

## 前言

从概念上讲，HTTP Live Streaming由三个部分组成：服务器组件，分发组件和客户端软件。

的服务器组件是负责采取的媒体输入流和数字编码它们，以适合于递送的格式将它们封装，以及制备所述包封的媒体分发。

该分配组件包括标准的Web服务器。他们负责接受客户端请求，并将准备好的媒体和相关资源交付给客户端。对于大规模分发，还可以使用边缘网络或其他内容传递网络。

该客户端软件负责确定适当的媒体请求，下载这些资源，然后重新装配即可，使得介质可以在一个连续的数据流被呈现给用户。客户端软件包含在iOS 3.0和更高版本以及装有Safari 4.0或更高版本的计算机上。

在典型配置中，硬件编码器接受音频视频输入，将其编码为H.264视频和AAC音频，然后以MPEG-2传输流输出，然后由软件分解为一系列简短的媒体文件流分割器。这些文件放置在Web服务器上。分段器还创建并维护一个包含媒体文件列表的索引文件。索引文件的URL在Web服务器上发布。客户端软件读取索引，然后按顺序请求列出的媒体文件并显示它们，而各段之间没有任何暂停或间隔。

一个简单的HTTP流配置示例如图

![alt](https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/StreamingMediaGuide/art/transport_stream_2x.png)

### 简单流程

1 http 请求 m3u8 的 url。

2 服务端返回一个 m3u8 的播放列表，这个播放列表是实时更新的，一般一次给出5段数据的 url。

3 客户端解析 m3u8 的播放列表，再按序请求每一段的 url，获取 ts 数据流。

### m3u8

M3U8 是 Unicode 版本的 M3U，用 UTF-8 编码。"M3U" 和 "M3U8" 文件都是苹果公司使用的 HTTP Live Streaming（HLS） 协议格式的基础

一个.M3U8文件是一个可扩展的播放列表文件格式。这是一个包含UTF-8编码文本的m3u播放列表。m3u文件格式是事实上的标准播放列表格式，适用于携带媒体文件URL列表。这是用作HTTP Live Streaming索引文件的格式。

### ts

TS（Transport Stream）: 动态文件流

一个.ts文件包含一个MPEG-2传输流。这是一种文件格式，封装了一系列编码的媒体样本，通常是音频和视频。该文件格式支持多种压缩格式，包括MP3音频，AAC音频，H.264视频等。但是，Apple HTTP Live Streaming实现当前不支持所有压缩格式。

### apple 推荐

apple 官方建议 m3u8 播放列表数3， ts 片段时长 10s，理论上延迟就有30s，还是太长了，我们尽量缩小 播放列表到1个 和ts时长到1s，对于服务器压力会越大，网速慢的时候会造成更多的缓冲

媒体文件应保留多长时间？

- 要考虑的主要点是，较短的段会导致索引文件的刷新频率更高，这可能会给客户端带来不必要的网络开销。较长的段会延长广播的固有延迟和初始启动时间。对于大多数广播内容，每个文件10秒的媒体持续时间似乎达到了合理的平衡。

连续不断的会话中，索引文件中应列出多少个文件 ？

- 正常建议为3，但最佳数量可能会更大。

- 选择最佳数量时要考虑的重要点是，在实时会话期间可用的文件数量会限制客户端在执行播放/暂停和搜索操作时的行为。列表中的文件越多，客户端可以在不失去广播位置的情况下暂停的时间就越长，加入流时新客户端开始在广播中返回的位置越远，客户端可以搜索的时间范围越广。代价是较长的索引文件会增加网络开销，在直播期间，客户端都会定期刷新索引文件，因此即使索引文件通常很小，它也确实会累加。

### 其他优化方式

如何减少开销并降低比特率？

- 使用更高效的编码器可以减少开销，调整编码器设置也可以。

m3u8 无法走CDN， m3u8 必须动态更新，ts 可以走 CDN。

## 总结

路由器，NAT或防火墙设置不太可能禁止使用HTTP。无需打开默认情况下通常关闭的端口。因此，内容更可能在更多位置到达客户端，而无需进行特殊设置。更多内容分发网络也支持HTTP，这可能会影响大型分发模型的成本。通常，与RTP / RTSP相比，更多可用的硬件和软件在未经修改的情况下以及与HTTP一起使用时的预期用途。使用PHP等工具自定义HTTP内容交付的专业知识也越来越广泛。

此外，Safari和iOS上的媒体播放器框架均支持HTTP Live Streaming。不支持RTSP流。

HLS 协议本质还是一个个的 HTTP 请求 / 响应，所以适应性很好，不会受到防火墙影响

### 参考文献

1. <https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/StreamingMediaGuide/HTTPStreamingArchitecture/HTTPStreamingArchitecture.html#//apple_ref/doc/uid/TP40008332-CH101-SW2>
