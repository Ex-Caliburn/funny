# jwt

## 前言

JSON Web Token（缩写 JWT）是目前最流行的跨域认证解决方案，本文介绍它的原理和用法。

## 总结

JWT 的几个特点
（1）JWT 默认是不加密，但也是可以加密的。生成原始 Token 以后，可以用密钥再加密一次。

（2）JWT 不加密的情况下，不能将秘密数据写入 JWT。

（3）JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数。

（4）JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑。

（5）JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证。

（6）为了减少盗用，JWT 不应该使用 HTTP 协议明码传输，要使用 HTTPS 协议传输。

### 问题1

）JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑。

也就是说一个用户在手机A中登录了，然后又在手机B中登录，在过期之前手机A和B都可以登录，无法做到B登录后让A过期，如果要做到这点，就必须让服务器维护一个清单（记录该账号是否已经签发token），这样又回到session的老路了

以上就是我们公司后端拒绝使用jwt的理由，我该怎么驳倒他？

1. 在数据库里或服务端存储机构保存用户等陆状态，如果登录状态发生变化，则重新签发一个包含登录状态码的JWT给客户端，原来的A设备因为登录状态码对不上号而被退出，A设备退出后，如果再次登录时再次重新签一个包含登录状态码的JWT给客户端，这样A手机重新登录后，B手机因为登录状态码对不上而被退出。

注意下：每次使用登录功能登录时登录时，客户端向服务端提交登录数据时，会连同发送重新设定登录状态码的指令，登录状态码为随机字符串。

完全没有理解JWT的意义，你这样表示所有请求全部都要去检查某个单点数据库里的所谓“登陆状态码”，那等于就是一个session。没有哪个数据库吃得消，必须用分布式内存存储。

2. 防止重复登陆，都是通过其他策略，例如：互斥ip控制，互斥设备控制等。token更多的是认证，而不是防重复。

#### 问题2

1. 不引入数据库支持的话这个的确没法实现。最好的方案是维护一张基于 jti (JWT ID) 的表，将jti和user_id关联起来，生成新的jwt时将该user_id旧的jwt标记为失效就好，具体场景还得看你们的具体业务逻辑。
2. 签名可以加时间戳或这其他随机参与加密，一旦登录就更新签名，之前的签名失效，不会出现多个在线啦
3. JWT 解决的最大问题是跨域，如果你们的业务不涉及跨域完全没有必要用JWT session 就够用了，如果有跨域需要，那么改造Session实现跨域访问，要比改造JWT实现单用户登陆复杂的多
4. 使用JWT用户数据由客户端传入，每个请求都会带着这些信息，也就不需要后端生成Session了，在每次请求的时候验证登陆状态及登陆用户

跨域这块，前端也是要处理的，两种情况：

1. token 存储在 cookie 里，按传统的跨域方案，共享/传递 cookie 里的 token
2. token 存储在 localStorage 里，则需要 localStorage 的跨域方案，以便 共享/传递 cookie 里的 token，localStorage 的跨域方案可以搜搜，有开源类库

1.其实jwt里面有加密的uid，或者是uid的对应关系

2.b系统产生不产生session，是你b系统的验证登录逻辑决定啊，你要从session验证用户，那就要写session，你如果是从redis验证token，就不需要写session

第四条是JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑。？

其实第四条说的有点绝对了，原文第四条的意思应该是jwt颁发后，一般扩展包没提供让其失效方法。但是要让jwt失效依然很简单，因为jwt一般会放在redis或者mysql表，只要逻辑上去找到uid对应的jwt，删了就可以了。

1. session+jwt 结合
2. session 只存：uid:lastTime, 别什么数据都往session 丢。用lastTime确定是否过期
3. 密码修改、A/B登录，lastTime都要更新。
4. 类似腾讯这种，同时支持pc+mobile，就用：uid:{pc:lastTime, mobile:lastTime}

我觉得只有在安全要求一般，且需要跨域的情况下才可以考虑JWT技术。

毕竟JWT签发后确实是服务器无法控制，如果你非得要通过维护一张JWT id表单来控制JWT失效，那和session比没有任何优势，反而还引入了安全性问题，得不偿失。

至于说到集群共享session的问题，通过分布式redis应该是可以很好的解决这一问题。

客户端收到服务器返回的 JWT，可以储存在 Cookie 里面，也可以储存在 localStorage

#### 问题2

浏览器存在 cookie 中的token 跨域也是非共享的， A系统登录后，浏览器访问B怎么拿到这个token?

如果你要访问B的时候携带 Token 过去，那把 Token 放在 Header参数，Url的Path参数，Query参数，Body参数都可以传过去，不一定非要放在 cookie 里面啊， Token 一般还是放在请求头里面的

#### 4

"举例来说，A 网站和 B 网站是同一家公司的关联服务。现在要求，用户只要在其中一个网站登录，再访问另一个网站就会自动登录，请问怎么实现？

一种解决方案是 session 数据持久化，写入数据库或别的持久层。各种服务收到请求后，都向持久层请求数据。这种方案的优点是架构清晰，缺点是工程量比较大。另外，持久层万一挂了，就会单点失败。"

个人感觉这种解决方案不是解决单点登录问题。单点登录问题的核心是如何让浏览器拥有目标网站的会话标识。

#### 5

防止JWT被篡改关键就在最后的签名：当客户端拿着JWT来服务器读取数据时，服务器会对Header和Payload以及秘钥再进行一次签名，和客户端返回的签名进行比对，如果不一致，就是被篡改了。

Header以及Payload都是Base64URL的编码，对应着就可以解码（任何人都可以，因为没有涉及到加密方式）。因此，重要信息不要放在这里面，比如同时存放用户名和密码。

好处我觉得很大啊：第一个，就是服务器的内存中不用和session机制那样存储用户状态数据了，分不式的我还没学到，不乱说；第二个，也不用把token存储在数据库了，如果存数据库，每次去数据库查询开销都不小（redis里存的话，和session区别就不大了，都是占用内存）。

另外，突然想到了如何让账号只能在一台设备登录？我看了各种文章都是登录的时候，在Redis里来保存JWT，客户端每次请求接口判断本次携带的JWT是否和Redis里保存的一直，不一致则登录失效。那如果这样做，感觉JWT的优势就没有了，有没有其他方法可以解决JWT同时只能有一个账号在线的问题？

#### 6

关于jwt 过期的问题。很多人说 可以在服务端记录 点什么东西来实现。
都这样做了。那还叫jwt吗，， 就和 原来的session 本质上没区别了。
jwt的核心就是 服务端不存东西。
传统的session。自己实现的话，那一样可以 服务端只存 sessionid+过期时间
然后数据加密给客户端。。

### 参考文献

1. <http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html>
